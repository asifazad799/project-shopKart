<style>
    .swal2-popup {
font-size: 1.1rem;
}
</style>
<body>
    <div class="page-wrapper">
       

        <main class="main">
        	<div class="page-header text-center" style="background-color: white;">
        		<div class="container">
        			<h1 class="page-title">Checkout</h1>
        		</div><!-- End .container -->
        	</div><!-- End .page-header -->
            {{!-- <nav aria-label="breadcrumb" class="breadcrumb-nav">
                <div class="container">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                        <li class="breadcrumb-item"><a href="#">Shop</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Checkout</li>
                    </ol>
                </div><!-- End .container -->
            </nav><!-- End .breadcrumb-nav --> --}}

            <div class="page-content">
            	<div class="checkout">
	                <div class="container">
            			<div class="checkout-discount">
            				{{!-- <form action="#">
        						<input type="text" class="form-control" required id="checkout-discount-input">
            					<label for="checkout-discount-input" class="text-truncate">Have a coupon? <span>Click here to enter your code</span></label>
            				</form> --}}
            			</div><!-- End .checkout-discount -->
            			<form action="#">
		                	<div class="row">
                                <div class="col-lg-7 p-5" style="background-color: #eeeeee; border-radius: 4px;">
                                    <div class="row pb-5">

                                    {{#each address.address}}
                                    <label class="col-lg-6 p-3"  for="{{this.addressId}}">
                                    
                                        <div style="background-color: #ffffff; border-radius: 4px; height: 100%; padding: 18px;">
                                            
                                            <div style="">
                                                <div class=" row d-flex-inline" >
                                                    <div class="col-10"></div>
                                                    <div class="col-2 ps-5">

                                                        <input class="" type="radio" onclick="selectedAddress('{{this.addressId}}')" style="margin-left: auto;" id="{{this.addressId}}" name="address">
                                                    </div>

                                                </div>
                                                <div style="height: 100%;">

                                                    <h6 class="text-dark f-w-400">Address </h6>
                                                    <p class=""><span style="font-weight: 400; color: black;">House Number:</span>{{this.houseNumber}}</p>
                                                    <p class=""><span style="font-weight: 400; color: black;">locality:</span>{{this.locality}}</p>
                                                    <p class=""><span style="font-weight: 400; color: black;">district:</span>{{this.district}}</p>
                                                    <p class=""><span style="font-weight: 400; color: black;">state:</span>{{this.state}}</p>
                                                    <p class=""><span style="font-weight: 400; color: black;">pincode:</span>{{this.pincode}}</p>

                                                </div>
                                            </div>
                                            <div class="pt-3 d-flex justify-content-around" >
                                                <div style="display: flex; position: absolute; bottom: 0; margin-bottom: 19px;">
                                                    

                                                    <div class="p-1 text-center" style="background-color: blue;border-radius: 2px; width: 40px; padding-left: 7px !important; cursor: pointer;">

                                                        <a href="/editAddress?addressId={{this.addressId}}" class="text-white"><i class="far fa-edit"></i></a>
                                                        {{!-- onclick="editAddress('{{this.addressId}}') --}}
                                                    </div>
                                                    <div class="p-3">

                                                    </div>
                                                    <div class="p-1 text-center" style="background-color: red;border-radius: 2px; width: 40px; cursor: pointer;">

                                                        <a onclick="deleteAddress('{{this.addressId}}')" class="text-white"><i class="far fa-trash-alt"></i></a>
                                                        
                                                    
                                                    </div>


                                                </div>

                                            </div>
                                        </div>
                                        
                                   
                                    </label>
                                    {{/each}}
                                    </div>
                                    <div class="row">

                                    <div class="d-flex justify-content-center">

                                        <a  href="/addNewAddress" class="btn btn-primary loginFormButton btn-order btn-block text-white mb-2" style="width: 100px; position: absolute; bottom: 0; margin-top: 20px !importent;">Add new address</a>

                                    </div>
                                    </div>

                                </div>
		                	
		                		<aside class="col-lg-5">
                                            <form action="#">
                                                <label for="checkout-discount-input" class="text-truncate">Have a coupon? <span>Click here to enter your code</span></label>
                                                <input type="text" class="form-control" required id="checkout-discount-input">
                                            </form>
		                			<div class="summary" style="border: none !important; background-color: #eeeeee;">
                                        <div class="checkout-discount">
                                        </div>
		                				<h4 class="">Your Order</h4><!-- End .summary-title -->

		                				<table class="table table-summary" style="border: none;">

		                					<tbody>
                                                {{#each response}}
		                						<tr>
		                							<td>{{this.product.productName}}</td>
		                							<td>₹{{this.mrp}}</td>
                                                    <td class="text-center">{{../quantity}}</td>
                                                    <td>₹{{../oldTotal}}</td>
		                						</tr>
                                                {{/each}}

		                						
		                						<tr class="summary-subtotal">
		                							<td>Subtotal:</td>
                                                    <td></td>
                                                    <td></td>
		                							<td>₹{{data.oldTotal}}</td>
		                						</tr><!-- End .summary-subtotal -->
		                						<tr>
		                							<td>Shipping : <span class="text-dark">{{data.delivery}}</span></td>
                                                    <td></td>
                                                    <td></td>
		                							<td>₹{{delCharge}}</td>
		                						</tr>
		                						<tr class="summary-total" >
		                							<td style="color: blue;">Total:</td>
                                                    <td></td>
                                                    <td></td>
		                							<td style="color: blue;">₹{{data.grandTotal}}</td>
		                						</tr><!-- End .summary-total -->
		                					</tbody>
		                				</table><!-- End .table table-summary -->

		                				<div class="accordion-summary" id="accordion-payment">
										    

										    <div class="card">
										        <div class="card-header" id="heading-3">
										            <h2 class="card-title">
										                {{!-- <a class="collapsed" role="button" data-toggle="collapse" href="#collapse-3" aria-expanded="false" aria-controls="collapse-3">
										                    Cash on delivery
										                </a> --}}
                                                        <label class="mb-1" for="COD"><input type="radio" id="COD" onclick="payment('COD')" style="height: 17px; width: 20px;" name="paymentMethod"><span style=" position: absolute; line-height: 16px; margin-left: 17px; font-size: 14px;" >Cash on delivery</span></label>

										            </h2>
										        </div><!-- End .card-header -->
										        <div id="collapse-3" class="collapse" aria-labelledby="heading-3" data-parent="#accordion-payment">
										            <div class="card-body">Quisque volutpat mattis eros. Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Donec odio. Quisque volutpat mattis eros. 
										            </div><!-- End .card-body -->
										        </div><!-- End .collapse -->
										    </div><!-- End .card -->

										    <div class="card">
										        <div class="card-header " id="heading-4">
										            <h2 class="card-title">
                                                        
										                {{!-- <a class="collapsed" role="button" data-toggle="collapse" href="#collapse-4" aria-expanded="false" aria-controls="collapse-4">
										                    PayPal <small class="float-right paypal-link">What is PayPal?</small>
										                </a> --}}
                                                        <label class="mb-1" for="paypal"><input type="radio" id="paypal" onclick="payment('paypal')" style="height: 17px; width: 20px;" name="paymentMethod"><span style=" position: absolute; line-height: 16px; margin-left: 17px; font-size: 14px;" >Paypal</span></label>
                                                        

										            </h2>
										        </div><!-- End .card-header -->
										        <div id="collapse-4" class="collapse" aria-labelledby="heading-4" data-parent="#accordion-payment">
										            <div class="card-body">
										                Nullam malesuada erat ut turpis. Suspendisse urna nibh, viverra non, semper suscipit, posuere a, pede. Donec nec justo eget felis facilisis fermentum.
										            </div><!-- End .card-body -->
										        </div><!-- End .collapse -->
										    </div><!-- End .card -->
                                            <div class="card">
										        <div class="card-header mb-3" id="heading-4">
										            <h2 class="card-title">
                                                        
										                {{!-- <a class="collapsed" role="button" data-toggle="collapse" href="#collapse-4" aria-expanded="false" aria-controls="collapse-4">
										                    PayPal <small class="float-right paypal-link">What is PayPal?</small>
										                </a> --}}
                                                        <label for="razorpay"><input type="radio" id="razorpay" onclick="payment('razorpay')" style="height: 17px; width: 20px;" name="paymentMethod"><span style=" position: absolute; line-height: 16px; margin-left: 17px; font-size: 14px;" >Razorpay</span></label>
                                                        

										            </h2>
										        </div><!-- End .card-header -->
										        <div id="collapse-4" class="collapse" aria-labelledby="heading-4" data-parent="#accordion-payment">
										            <div class="card-body">
										                Nullam malesuada erat ut turpis. Suspendisse urna nibh, viverra non, semper suscipit, posuere a, pede. Donec nec justo eget felis facilisis fermentum.
										            </div><!-- End .card-body -->
										        </div><!-- End .collapse -->
										    </div>

										    <!-- End .accordion -->

                                        {{#each response}} 
                                        <a   onclick="placeOrder('{{../data.grandTotal}}','{{../data.delivery}}','{{../this.quantity}}','{{this._id}}')" class="btn btn-primary loginFormButton btn-order btn-block text-white">Place Order</a>
                                        {{/each}}
		                				{{!-- <button type="submit" class="btn  btn-order btn-block">
		                					 <a  href="/checkOut" class="btn btn-primary loginFormButton btn-order btn-block text-white">Proceed To Checkout</a>
		                					 <a  href="/checkOut" class="btn btn-primary loginFormButton btn-order btn-block text-white">Proceed To Checkout</a>
		                				</button> --}}
		                			</div><!-- End .summary -->
		                		</aside><!-- End .col-lg-3 -->
		                	</div><!-- End .row -->
            			</form>
	                </div><!-- End .container -->
                </div><!-- End .checkout -->
            </div><!-- End .page-content -->
        </main><!-- End .main -->

      
    </div><!-- End .page-wrapper -->
    <button id="scroll-top" title="Back to Top"><i class="icon-arrow-up"></i></button>

    <!-- Mobile Menu -->
    <div class="mobile-menu-overlay"></div><!-- End .mobil-menu-overlay -->

   



<script>
    function deleteAddress(addressId){

        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {

                $.ajax({
                    url:"/deleteAddress",
                    method:'post',
                    data:{address:addressId},
                    success:(result)=>{
                        if(result){

                            Swal.fire(
                                'Deleted!',
                                'Your file has been deleted.',
                                'success'
                            ).then((result)=>{
                                window.location.reload()
                                })
                            setTimeout(window.location.reload.bind(window.location),3050);
                        }
                    }
                })
            }
        })
    }

    let address = null;
    let paymentMethod = null;

    function selectedAddress(addressId){
        
        address = addressId;
        
        //console.log(address)
    }
    function payment(paymentMethods){
        
        paymentMethod = paymentMethods

        //console.log(paymentMethod)
    }

    
                

                    

                    

                


    function placeOrder(finalTotal,deliveryType,orderQuantity,productId){

        //console.log(productId)

        if(address){
            
            if(paymentMethod){

                //console.log(deliveryType)
                $.ajax({
                    url:'/dirPlaceOrder',
                    method:'post',
                    data:{finalTotal:finalTotal,
                            deliveryType:deliveryType,
                            paymentMethod:paymentMethod,
                            address:address,
                            quantity:orderQuantity,
                            productId:productId},
                    success:(response)=>{
                        
                        if(response.cod){
                        
                            location.href = '/orderSuccessPage'

                        }else if(response.paypal){

                            location.href = response.url

                        }
                        else{
                            
                            razorpayPayment(response)
                            //console.log(response)

                        }

                    }
                })

                function razorpayPayment(order){
                    //console.log('asif azad payment')
                    var options = {
                        "key": "rzp_test_17oewiAfnFqdfq", // Enter the Key ID generated from the Dashboard
                        "amount": order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                        "currency": "INR",
                        "name": "Acme Corp",
                        "description": "Test Transaction",
                        "image": "",
                        "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                        "handler": function (response){
                           
                            //onsole.log('To server')
                            verifyPayment(response,order)
                           

                        },
                        "prefill": {
                            "name": "Gaurav Kumar",
                            "email": "gaurav.kumar@example.com",
                            "contact": "9999999999"
                        },
                        "notes": {
                            "address": "Razorpay Corporate Office"
                        },
                        "theme": {
                            "color": "#3399cc"
                        }
                    };
                    var razor = new Razorpay(options);
                    razor.open()

                }
                function verifyPayment(response,order){

                $.ajax({
                    
                    url:'/verifyPaymentDir',
                    data:{response:response,order:order},
                    method:'post',
                    success:(response)=>{
                        
                        if(response.status){
                            
                            location.href = '/orderSuccessPage'

                        }else{
                            
                            Swal.fire({
                                position: 'top-end',
                                icon: 'error',
                                title: 'Something Went wrong',
                                showConfirmButton: false,
                                timer: 1500
                            })

                        }


                    }

                })

               }
                
            }else{

                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top',
                    padding:'3em',
                    showConfirmButton: false,
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer)
                        toast.addEventListener('mouseleave', Swal.resumeTimer)
                    }
                })

                Toast.fire({
                    icon: 'error',
                    title: 'Please select a payment method'
                })
               
            }

        }else{
            
            //console.log('select address')
             const Toast = Swal.mixin({
                toast: true,
                position: 'top',
                padding:'3em',
               
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer)
                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                }
            })

            Toast.fire({
                icon: 'error',
                title: 'please select an address'
            })
            
            
        }
        

    }

    </script>
</body>

                
                

 
   
